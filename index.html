<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Portal</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --accent: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f9f9f9; }
        
        #sidebar { width: 280px; background: white; border-left: 1px solid #ddd; padding: 20px; height: 100vh; position: fixed; right: 0; top: 0; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }
        .q-circle { width: 35px; height: 35px; border-radius: 4px; border: 1px solid #ccc; display: inline-flex; align-items: center; justify-content: center; margin: 5px; cursor: pointer; font-weight: bold; }
        .attempted { background: var(--success) !important; color: white; border: none; }
        .current { border: 2px solid var(--accent); }

        #main-content { margin-right: 320px; padding: 50px; }
        .timer { font-size: 2rem; color: var(--danger); font-weight: bold; margin-bottom: 20px; }
        .hidden { display: none; }
        
        .option-card { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; background: white; text-align: left; cursor: pointer; transition: 0.2s; }
        .option-card:hover { background: #f0f7ff; border-color: var(--accent); }
        .selected { background: #e3f2fd !important; border-color: var(--accent) !important; font-weight: bold; }

        .btn-nav { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-right: 10px; }
        .btn-next { background: var(--accent); color: white; }
        .btn-finish { background: var(--danger); color: white; float: right; }

        #final-screen { text-align: center; padding-top: 100px; }
    </style>
</head>
<body>

    <div id="login-screen" style="max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h2>Candidate Login</h2>
        <input type="text" id="username" placeholder="Enter Full Name" style="width: 80%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px;">
        <button class="btn-nav btn-next" style="width: 85%;" onclick="startExam()">Enter Exam Hall</button>
    </div>

    <div id="exam-container" class="hidden">
        <div id="main-content">
            <div class="timer" id="timer-display">30:00</div>
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h2 id="q-text">Question Loading...</h2>
                <div id="options-container"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn-nav" onclick="changeQuestion(-1)">Previous</button>
                <button class="btn-nav btn-next" onclick="changeQuestion(1)">Next</button>
                <button class="btn-finish" onclick="finishExam()">Submit Examination</button>
            </div>
        </div>

        <div id="sidebar">
            <h3>Question Palette</h3>
            <hr>
            <div id="question-grid"></div>
            <div style="margin-top: 50px; font-size: 0.9rem; color: #666;">
                <p><span style="color: var(--success)">●</span> Attempted</p>
                <p><span style="color: #ccc">●</span> Unattempted</p>
            </div>
        </div>
    </div>

    <div id="final-screen" class="hidden">
        <div style="background: white; max-width: 600px; margin: auto; padding: 50px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h1 style="color: var(--success);">Examination Submitted!</h1>
            <p style="font-size: 1.2rem; color: #555;">Thank you for completing the test.</p>
            <p>Your responses have been recorded securely. The official rank list will be published on the notice board soon.</p>
            <br>
            <button class="btn-nav btn-next" onclick="location.reload()">Back to Home</button>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        let currentIdx = 0;
        let userAnswers = new Array(quizQuestions.length).fill(null);
        let timeLeft = 50 * 60;
        let timerInterval;

        const FORM_ID = "1FAIpQLSfdc6KygQ100hICyXkaJYIWVJ7UxKYUw4aV22smmT3nRWCu3g"; 
        const ENTRY_NAME = "entry.1088098272";
        const ENTRY_SCORE = "entry.1899459571";
        const ENTRY_TIME = "entry.1956296565";

        function startExam() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Enter your name to proceed");
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            renderGrid();
            showQuestion();
            startTimer();
        }

        function renderGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const btn = document.createElement('div');
                btn.className = 'q-circle';
                btn.id = `grid-q-${i}`;
                btn.innerText = i + 1;
                btn.onclick = () => { currentIdx = i; showQuestion(); };
                grid.appendChild(btn);
            });
        }

        function showQuestion() {
            const q = quizQuestions[currentIdx];
            document.getElementById('q-text').innerText = `Question ${currentIdx + 1}: ${q.question}`;
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            // Update sidebar focus
            document.querySelectorAll('.q-circle').forEach(el => el.classList.remove('current'));
            document.getElementById(`grid-q-${currentIdx}`).classList.add('current');

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `option-card ${userAnswers[currentIdx] === i ? 'selected' : ''}`;
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                container.appendChild(btn);
            });
        }

        function selectOption(optIdx) {
            userAnswers[currentIdx] = optIdx;
            document.getElementById(`grid-q-${currentIdx}`).classList.add('attempted');
            showQuestion();
        }

        function changeQuestion(step) {
            let newIdx = currentIdx + step;
            if(newIdx >= 0 && newIdx < quizQuestions.length) {
                currentIdx = newIdx;
                showQuestion();
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
                if(timeLeft <= 0) finishExam();
            }, 1000);
        }

        function finishExam() {
            if(!confirm("Are you sure you want to submit?")) return;
            
            clearInterval(timerInterval);
            
            // Calculate marks: +1 correct, -1/3 wrong
            let total = 0;
            userAnswers.forEach((ans, i) => {
                if(ans === null) return; 
                if(ans === quizQuestions[i].correct) total += 1;
                else total -= (1/3);
            });

            const finalScore = total.toFixed(2);
            const name = document.getElementById('username').value;
            const timeTaken = `${30 - Math.floor(timeLeft/60)}m ${60 - (timeLeft%60)}s`;

            // Background submission
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?` + 
                        `${ENTRY_NAME}=${encodeURIComponent(name)}&` +
                        `${ENTRY_SCORE}=${finalScore}&` +
                        `${ENTRY_TIME}=${encodeURIComponent(timeTaken)}&submit=Submit`;

            fetch(url, { mode: 'no-cors' });

            // Show Final Screen
            document.getElementById('exam-container').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
