<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBT Exam Portal</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; }
        
        /* Sidebar Navigation */
        #sidebar { width: 300px; background: #f4f4f4; border-left: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .q-circle { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #999; 
                    display: inline-flex; align-items: center; justify-content: center; 
                    margin: 5px; cursor: pointer; background: white; }
        .attempted { background: var(--success) !important; color: white; border: none; }

        /* Main Exam Area */
        #main-content { flex: 1; padding: 40px; position: relative; }
        .timer { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; font-weight: bold; color: var(--danger); }
        .hidden { display: none; }
        .options-btn { display: block; width: 100%; margin: 10px 0; padding: 10px; text-align: left; cursor: pointer; }
        .nav-footer { margin-top: 30px; }
        button { padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" style="text-align:center; width:100%; margin-top:100px;">
        <h1>CBT Examination System</h1>
        <input type="text" id="username" placeholder="Enter Full Name" style="padding:10px; width:250px;"><br><br>
        <button onclick="startExam()">Start Examination</button>
    </div>

    <div id="exam-container" class="hidden" style="display:flex; width:100%;">
        <div id="main-content">
            <div class="timer" id="timer-display">30:00</div>
            <h2 id="q-text">Question Loading...</h2>
            <div id="options-container"></div>
            
            <div class="nav-footer">
                <button onclick="changeQuestion(-1)">Previous</button>
                <button onclick="changeQuestion(1)">Next</button>
                <button id="submit-btn" onclick="finishExam()" style="background:var(--danger); color:white; margin-left:50px;">Finish Exam</button>
            </div>
        </div>

        <div id="sidebar">
            <h3>Questions</h3>
            <div id="question-grid"></div>
        </div>
    </div>

    <script src="questions.js"></script>

    <script>
        let currentIdx = 0;
        let userAnswers = new Array(quizQuestions.length).fill(null);
        let timeLeft = 30 * 60; // 30 minutes in seconds
        let timerInterval;

        const FORM_ID = "1FAIpQLSfdc6KygQ100hICyXkaJYIWVJ7UxKYUw4aV22smmT3nRWCu3g"; 
        const ENTRY_NAME = "entry.1088098272";
        const ENTRY_SCORE = "entry.1899459571";
        const ENTRY_TIME = "entry.1956296565";

        function startExam() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Please enter your name");
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            document.getElementById('exam-container').style.display = 'flex';
            
            renderGrid();
            showQuestion();
            startTimer();
        }

        function renderGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const btn = document.createElement('div');
                btn.className = 'q-circle';
                btn.id = `grid-q-${i}`;
                btn.innerText = i + 1;
                btn.onclick = () => { currentIdx = i; showQuestion(); };
                grid.appendChild(btn);
            });
        }

        function showQuestion() {
            const q = quizQuestions[currentIdx];
            document.getElementById('q-text').innerText = `Q${currentIdx + 1}: ${q.question}`;
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'options-btn';
                btn.innerText = opt;
                if(userAnswers[currentIdx] === i) btn.style.background = '#d1e7ff';
                btn.onclick = () => selectOption(i);
                container.appendChild(btn);
            });
        }

        function selectOption(optIdx) {
            userAnswers[currentIdx] = optIdx;
            document.getElementById(`grid-q-${currentIdx}`).classList.add('attempted');
            showQuestion();
        }

        function changeQuestion(step) {
            currentIdx += step;
            if(currentIdx < 0) currentIdx = 0;
            if(currentIdx >= quizQuestions.length) currentIdx = quizQuestions.length - 1;
            showQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
                if(timeLeft <= 0) finishExam();
            }, 1000);
        }

        function calculateScore() {
            let score = 0;
            userAnswers.forEach((ans, i) => {
                if(ans === null) return;
                if(ans === quizQuestions[i].correct) {
                    score += 1;
                } else {
                    score -= (1/3);
                }
            });
            return score.toFixed(2);
        }

        function finishExam() {
            clearInterval(timerInterval);
            const finalScore = calculateScore();
            const name = document.getElementById('username').value;
            const timeTaken = `${30 - Math.floor(timeLeft/60)} mins`;

            // Prepare Google Form URL
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?` + 
                        `${ENTRY_NAME}=${encodeURIComponent(name)}&` +
                        `${ENTRY_SCORE}=${finalScore}&` +
                        `${ENTRY_TIME}=${encodeURIComponent(timeTaken)}&submit=Submit`;

            // Silent submission using Fetch (CORS might block, so we use 'no-cors')
            fetch(url, { mode: 'no-cors' }).then(() => {
                alert(`Exam Submitted Successfully! Score: ${finalScore}`);
                location.reload(); 
            });
        }
    </script>
</body>
</html>
